# نظام أسعار صرف العملات المنفصل

## نظرة عامة

تم إنشاء نظام منفصل لإدارة أسعار صرف العملات ، منفصل تماماً عن نظام أسعار صرف الحوالات. هذا يضمن عدم حدوث تداخل أو مشاكل عند التبديل بين الحوالات وعمليات تبديل العملات.

## المكونات الجديدة

### 1. النماذج (Models)

#### `FxExchangeRate.cs`

- نموذج منفصل لأسعار صرف العملات
- يحتوي على:
  - `Currency`: العملة (USD, EUR, GBP, etc.)
  - `BuyRate`: سعر الشراء (الصندوق يشتري العملة من العميل)
  - `SellRate`: سعر البيع (الصندوق يبيع العملة للعميل)
  - `CashierId`: معرف الصندوق المسؤول
  - `Notes`: ملاحظات إضافية

#### `FxDbContext.cs`

- قاعدة بيانات منفصلة تماماً عن قاعدة بيانات الحوالات
- تحتوي على جدول `FxExchangeRates` فقط
- فهرس فريد على العملة لمنع التكرار

### 2. قاعدة البيانات

#### قاعدة بيانات منفصلة: `AlawnehEwayFxDb`

- منفصلة تماماً عن قاعدة بيانات الحوالات الرئيسية
- تحتوي على جدول `FxExchangeRates` فقط
- Connection string منفصل في `appsettings.json`

### 3. APIs الجديدة

#### أسعار صرف العملات

- `GET /fx-exchange-rates` - جلب جميع أسعار صرف العملات
- `GET /fx-exchange-rates/{currency}` - جلب سعر صرف عملة معينة
- `POST /fx-exchange-rates` - إضافة سعر صرف جديد
- `PUT /fx-exchange-rates/{id}` - تحديث سعر صرف موجود
- `DELETE /fx-exchange-rates/{id}` - حذف سعر صرف

### 4. واجهة المستخدم

#### صفحة `fx_exchange_rates.html`

- واجهة منفصلة لإدارة أسعار صرف العملات
- إمكانية إضافة/تعديل/حذف أسعار الصرف
- عرض الفرق بين سعر الشراء والبيع
- ربط ببيانات الصناديق

## الفوائد

### 1. الفصل الكامل

- لا يوجد تداخل بين أسعار صرف الحوالات وأسعار صرف العملات
- كل نظام له قاعدة بيانات منفصلة
- لا توجد مشاكل عند التبديل بين النظامين

### 2. المرونة

- يمكن تحديث أسعار صرف العملات دون التأثير على الحوالات
- إدارة منفصلة للصلاحيات
- إمكانية إضافة ميزات خاصة بكل نظام

### 3. الأمان

- فصل البيانات الحساسة
- إمكانية نسخ احتياطي منفصل
- تحكم أفضل في الوصول

## التثبيت والتشغيل

### 1. تطبيق Migrations

```powershell
# تشغيل script التثبيت
.\apply-fx-migrations.ps1
```

### 2. إعداد Connection Strings

تأكد من وجود connection strings في `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=AlawnehEwayDb;Trusted_Connection=true;MultipleActiveResultSets=true",
    "FxConnection": "Server=(localdb)\\mssqllocaldb;Database=AlawnehEwayFxDb;Trusted_Connection=true;MultipleActiveResultSets=true"
  }
}
```

### 3. الوصول للواجهة

- انتقل إلى الصفحة الرئيسية
- اختر "أسعار صرف العملات" من قائمة المدير
- أو انتقل مباشرة إلى `/fx_exchange_rates.html`

## الاستخدام

### إضافة سعر صرف جديد

1. اختر العملة من القائمة المنسدلة
2. أدخل سعر الشراء (أقل من سعر البيع)
3. أدخل سعر البيع (أعلى من سعر الشراء)
4. اختر الصندوق المسؤول
5. أضف أي ملاحظات
6. احفظ

### تعديل سعر موجود

1. اضغط على أيقونة التعديل بجانب السعر
2. عدّل القيم المطلوبة
3. احفظ التغييرات

### حذف سعر صرف

1. اضغط على أيقونة الحذف
2. أكد الحذف في النافذة المنبثقة

## الميزات المتقدمة

### حساب الفرق (Spread)

- يتم حساب الفرق تلقائياً بين سعر الشراء والبيع
- عرض النسبة المئوية للفرق
- يساعد في تحديد ربحية العملة

### ربط بالصناديق

- كل سعر صرف مرتبط بصندوق معين
- تتبع من قام بإضافة/تعديل السعر
- إمكانية إدارة الصلاحيات

### التحقق من صحة البيانات

- سعر الشراء يجب أن يكون أقل من سعر البيع
- منع إدخال قيم سالبة
- فحص التكرار في العملات

## الصيانة

### النسخ الاحتياطي

```sql
-- نسخ احتياطي لقاعدة بيانات أسعار صرف العملات
BACKUP DATABASE AlawnehEwayFxDb TO DISK = 'C:\Backup\AlawnehEwayFxDb.bak'
```

### مراقبة الأداء

- فحص حجم قاعدة البيانات
- مراقبة سرعة الاستعلامات
- تحسين الفهارس عند الحاجة

## استكشاف الأخطاء

### مشاكل الاتصال

1. تأكد من صحة connection string
2. تحقق من تشغيل SQL Server
3. راجع logs التطبيق

### مشاكل البيانات

1. تحقق من صحة البيانات المدخلة
2. راجع قيود قاعدة البيانات
3. تأكد من تطبيق migrations

## التطوير المستقبلي

### ميزات مقترحة

- إشعارات عند تغيير الأسعار
- تاريخ تغيير الأسعار
- مقارنة الأسعار مع مصادر خارجية
- تقارير مفصلة عن الأرباح
- API للعملات الرقمية

### تحسينات الأداء

- تخزين مؤقت للأسعار
- تحسين استعلامات قاعدة البيانات
- ضغط البيانات القديمة
