<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø±Ø¬Ø§Ø¹/ØªØ¹Ø¯ÙŠÙ„ Ø­ÙˆØ§Ù„Ø© - Alawneh-Eway</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
        .details-card { background: transparent; color: #6c757d; padding: 20px; margin-top: 12px; }
        .details-card div { margin-bottom: 8px; }
        .details-card strong { color: #6c757d; }
        .badge-status { padding: 4px 10px; font-weight: bold; color: #6c757d; display: inline-block; }
        .badge-pending { color: #6c757d; }
        .badge-paid { color: #6c757d; }
        .badge-pending-approval { color: #6c757d; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .muted { color: #6c757d; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <script>
        const API_BASE_URL = window.location.origin;
        let current = null;
        let autoRefreshInterval = null;

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙØ§Ù„ÙŠØ¯ÙŠØ´Ù†
        function validateReferenceNumber(reference) {
            if (!reference || reference.trim() === '') {
                return 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù…Ø·Ù„ÙˆØ¨';
            }
            // Ù‚Ø¨ÙˆÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: RM-YYYYMMDD-HHMMSS-XXX Ø£Ùˆ Ø£ÙŠ ØªÙ†Ø³ÙŠÙ‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ RM-
            if (!reference.trim().startsWith('RM-')) {
                return 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ RM-';
            }
            return null;
        }

        function validateNumericField(value, fieldName) {
            if (!value || value.trim() === '') {
                return null; // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
            }
            if (!/^\d+(\.\d+)?$/.test(value.trim())) {
                return `${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·`;
            }
            return null;
        }

        async function findByRef() {
            const ref = document.getElementById('reference').value.trim();
            
            // ÙØ§Ù„ÙŠØ¯ÙŠØ´Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ
            const refError = validateReferenceNumber(ref);
            if (refError) {
                alert(refError);
                render(null);
                stopAutoRefresh();
                return;
            }
            
            const res = await fetch(`${API_BASE_URL}/remittances/by-ref/${encodeURIComponent(ref)}`);
            if (!res.ok) { 
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­ÙˆØ§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ'); 
                render(null);
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù„Ø©
                const returnCard = document.getElementById('returnCard');
                const updateCard = document.getElementById('updateCard');
                if (returnCard) returnCard.style.display = 'none';
                if (updateCard) updateCard.style.display = 'none';
                stopAutoRefresh();
                return; 
            }
            const r = await res.json();
            current = r; 
            render(r);
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
            if (r.status === 'Pending Approval') {
                startAutoRefresh(ref);
            } else {
                stopAutoRefresh();
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            const notesField = document.getElementById('notes');
            if (notesField && (r.status === 'Payment pending' || r.status === 'Pending Approval')) {
                notesField.style.display = 'block';
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        async function refreshCurrentRemittance() {
            if (!current || !current.reference) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/remittances/by-ref/${encodeURIComponent(current.reference)}`);
                if (res.ok) {
                    const updatedRemittance = await res.json();
                    const oldStatus = current.status;
                    current = updatedRemittance;
                    render(updatedRemittance);
                    
                    // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† "Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" Ø¥Ù„Ù‰ "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹"ØŒ ØªÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    if (oldStatus === 'Pending Approval' && updatedRemittance.status === 'Payment pending') {
                        stopAutoRefresh();
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        showStatusChangeNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹" ÙˆÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯');
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªØ¹ÙˆØ¯ Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                        updateButtonsBasedOnStatus('Payment pending');
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function startAutoRefresh(reference) {
            stopAutoRefresh(); // ØªÙˆÙ‚Ù Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ø³Ø§Ø¨Ù‚
            autoRefreshInterval = setInterval(refreshCurrentRemittance, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        function showStatusChangeNotification(title, message) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¨ØµØ±ÙŠ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 15px 20px;
                border-radius: 8px;
                border: 1px solid #c3e6cb;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 400px;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="font-size: 18px;"></i>
                    <div>
                        <strong>${title}</strong><br>
                        ${message}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #155724; cursor: pointer; font-size: 16px;">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 8000);
        }

        function render(r) {
            const box = document.getElementById('details');
            if (!r) { box.innerHTML = '<div style="color:#333">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'; return; }

            let statusBadgeClass = '';
            let statusText = mapStatusToArabic(r.status);
            if (r.status === 'Payment pending') {
                statusBadgeClass = 'badge-pending';
            } else if (r.status === 'Paid') {
                statusBadgeClass = 'badge-paid';
            } else if (r.status === 'Pending Approval') {
                statusBadgeClass = 'badge-pending-approval';
            }

            box.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="padding-left: 15px;">
                        <h3 style="color: #333; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø©</h3>
                        <div><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ:</strong> <span class="pill">${r.reference}</span></div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge-status ${statusBadgeClass}">${statusText}</span></div>
                        <div><strong>Ø§Ù„Ø¯ÙˆÙ„Ø©:</strong> ${r.country}</div>
                        <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <b style="font-size: 1.2em;">${r.amount.toFixed(2)}</b> Ø¯.Ø£</div>
                        <div><strong>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</strong> ${r.fee.toFixed(2)} Ø¯.Ø£</div>
                        <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ:</strong> <b>${(r.amount - r.fee).toFixed(2)}</b> Ø¯.Ø£</div>
                        <div><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${r.reason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø§Ù„ØºØ§ÙŠØ©:</strong> ${r.purpose || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:</strong> ${formatDate(r.createdAt)}</div>
                        ${r.paidAt ? `<div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­Ø¨:</strong> ${formatDate(r.paidAt)}</div>` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: white;">
                            <h4 style="color: #333; margin-bottom: 10px;"><i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„</h4>
                            <div><strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:</strong> ${r.sender?.nameAr ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ:</strong> ${r.sender?.nameEn ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ:</strong> ${r.sender?.nationalId ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${r.sender?.phoneNumber ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        
                        <div style="padding: 15px; background: white;">
                            <h4 style="color: #333; margin-bottom: 10px;"><i class="fas fa-user-check"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</h4>
                            <div><strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:</strong> ${r.beneficiary?.nameAr ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ:</strong> ${r.beneficiary?.nameEn ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ:</strong> ${r.beneficiary?.nationalId ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${r.beneficiary?.phoneNumber ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø©
            updateButtonsBasedOnStatus(r.status);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø­ÙˆØ§Ù„Ø© Ù…Ø¹Ø±ÙˆØ¶Ø©
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.style.display = r ? 'block' : 'none';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            if (current) {
                current.status = r.status;
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø©
            const returnCard = document.getElementById('returnCard');
            const updateCard = document.getElementById('updateCard');
            
            if (r && (r.status === 'Payment pending' || r.status === 'Pending Approval')) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
                if (returnCard) returnCard.style.display = 'block';
                if (updateCard) updateCard.style.display = 'block';
            } else if (r && r.status === 'Paid') {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ù…Ø¯ÙÙˆØ¹Ø©
                if (returnCard) returnCard.style.display = 'none';
                if (updateCard) updateCard.style.display = 'none';
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
                if (returnCard) returnCard.style.display = 'none';
                if (updateCard) updateCard.style.display = 'none';
            }
        }

        function updateButtonsBasedOnStatus(status) {
            const returnButton = document.querySelector('button[onclick="requestReturn()"]') || 
                                document.querySelector('button[onclick*="requestReturn"]');
            const updateButton = document.querySelector('button[onclick="requestUpdate()"]') || 
                                document.querySelector('button[onclick*="requestUpdate"]');
            
            if (status === 'Pending Approval') {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© ÙˆÙ„ÙƒÙ† Ø§ØªØ±Ùƒ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù†Ø´Ø·Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
                if (returnButton) {
                    returnButton.innerHTML = '<i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© - ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
                    returnButton.className = 'btn btn-warning';
                    returnButton.disabled = false;
                    // Ø¥Ø¨Ù‚Ø§Ø¡ onclick ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                }
                if (updateButton) {
                    updateButton.innerHTML = '<i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© - ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
                    updateButton.className = 'btn btn-warning';
                    updateButton.disabled = false;
                    // Ø¥Ø¨Ù‚Ø§Ø¡ onclick ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                }
            } else if (status === 'Paid') {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ù…Ø¯ÙÙˆØ¹Ø©ØŒ Ø¹Ø·Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                if (returnButton) {
                    returnButton.innerHTML = '<i class="fas fa-ban"></i> ØºÙŠØ± Ù…ØªØ§Ø­ - Ù…Ø¯ÙÙˆØ¹Ø©';
                    returnButton.className = 'btn btn-secondary';
                    returnButton.disabled = true;
                    returnButton.onclick = null;
                }
                if (updateButton) {
                    updateButton.innerHTML = '<i class="fas fa-ban"></i> ØºÙŠØ± Ù…ØªØ§Ø­ - Ù…Ø¯ÙÙˆØ¹Ø©';
                    updateButton.className = 'btn btn-secondary';
                    updateButton.disabled = true;
                    updateButton.onclick = null;
                }
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                if (returnButton) {
                    returnButton.innerHTML = '<i class="fas fa-undo"></i> Ø·Ù„Ø¨ Ø¥Ø±Ø¬Ø§Ø¹';
                    returnButton.className = 'btn btn-warning';
                    returnButton.disabled = false;
                    returnButton.onclick = requestReturn;
                }
                if (updateButton) {
                    updateButton.innerHTML = '<i class="fas fa-pen"></i> Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„';
                    updateButton.className = 'btn btn-info';
                    updateButton.disabled = false;
                    updateButton.onclick = requestUpdate;
                }
            }
        }

        async function requestReturn() {
            if (!current) { alert('Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙˆØ§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
            
            // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø­ÙˆØ§Ù„Ø©ØŸ\n\nØ³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©"')) {
                return;
            }
            
            const payload = { requestType: 1, notes: document.getElementById('notesReturn').value.trim() };
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests?reference=${encodeURIComponent(current.reference)}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!res.ok) { alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹'); return; }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            current.status = 'Pending Approval';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            updateButtonsBasedOnStatus('Pending Approval');
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯/Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨
            if (current && current.reference) {
                startAutoRefresh(current.reference);
            }
            
            // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„
            alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
                  'ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:\n' +
                  `â€¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${current.reference}\n` +
                  `â€¢ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø©\n` +
                  `â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\n` +
                  `â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${new Date().toLocaleString('ar-SA')}\n\n` +
                  'Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
        }

        async function requestUpdate() {
            if (!current) { alert('Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙˆØ§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
            
            // ÙØ§Ù„ÙŠØ¯ÙŠØ´Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡
            const amountValue = document.getElementById('amount').value;
            if (amountValue) {
                const amountError = validateNumericField(amountValue, 'Ø§Ù„Ù…Ø¨Ù„Øº');
                if (amountError) {
                    alert(amountError);
                    return;
                }
                const amount = parseFloat(amountValue);
                if (amount <= 0) {
                    alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
                    return;
                }
            }
            
            // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø­ÙˆØ§Ù„Ø©ØŸ\n\nØ³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©"')) {
                return;
            }
            
            const payload = {
                requestType: 2,
                notes: document.getElementById('notesUpdate').value.trim(),
                proposedCountry: document.getElementById('country').value || null,
                proposedAmount: document.getElementById('amount').value ? parseFloat(document.getElementById('amount').value) : null,
                proposedReason: document.getElementById('reason').value || null,
                proposedPurpose: document.getElementById('purpose').value || null
            };
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests?reference=${encodeURIComponent(current.reference)}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!res.ok) { alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); return; }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            current.status = 'Pending Approval';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            updateButtonsBasedOnStatus('Pending Approval');
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯/Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨
            if (current && current.reference) {
                startAutoRefresh(current.reference);
            }
            
            // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„
            const changes = [];
            if (payload.proposedCountry) changes.push(`â€¢ Ø§Ù„Ø¯ÙˆÙ„Ø©: ${payload.proposedCountry}`);
            if (payload.proposedAmount) changes.push(`â€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${payload.proposedAmount} Ø¯.Ø£`);
            if (payload.proposedReason) changes.push(`â€¢ Ø§Ù„Ø³Ø¨Ø¨: ${payload.proposedReason}`);
            if (payload.proposedPurpose) changes.push(`â€¢ Ø§Ù„ØºØ§ÙŠØ©: ${payload.proposedPurpose}`);
            
            alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
                  'ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:\n' +
                  `â€¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${current.reference}\n` +
                  `â€¢ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø©\n` +
                  `â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\n` +
                  `â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${new Date().toLocaleString('ar-SA')}\n\n` +
                  'ğŸ“ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n' +
                  (changes.length > 0 ? changes.join('\n') : 'â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ø¯Ø¯Ø©') + '\n\n' +
                  'Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // Ø¥Ø¶Ø§ÙØ© 3 Ø³Ø§Ø¹Ø§Øª Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (UTC+3)
            date.setHours(date.getHours() + 3);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const strHours = hours.toString().padStart(2, '0');

            return `${month}/${day}/${year} ${strHours}:${minutes} ${ampm}`;
        }
        
        function mapStatusToArabic(status) {
            switch (status) {
                case 'Payment pending': return 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹';
                case 'Paid': return 'Ù…Ø¯ÙÙˆØ¹Ø©';
                case 'Pending Approval': return 'Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                default: return status;
            }
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div class="logo">
                    <i class="fas fa-rotate"></i>
                    <h1>Ø¥Ø±Ø¬Ø§Ø¹/ØªØ¹Ø¯ÙŠÙ„ Ø­ÙˆØ§Ù„Ø©</h1>
                </div>
                <a href="index.html" style="color: #ffffff; text-decoration: none; font-size: 16px; display: flex; align-items: center; gap: 6px; transition: opacity 0.3s;">
                    <i class="fas fa-home"></i>
                    <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </a>
            </div>
            <p class="subtitle">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø«Ù… Ø§Ø®ØªØ± Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­ ØªØ¹Ø¯ÙŠÙ„</p>
        </header>

        <main class="main-content">
            <div class="card">
                <div style="display: flex; gap: 10px;">
                    <input id="reference" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ" style="flex: 1; font-size: 18px; padding: 12px;">
                    <button class="btn btn-primary" onclick="findByRef()"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
                    <button class="btn btn-secondary" onclick="refreshCurrentRemittance()" id="refreshBtn" style="display: none;"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="details" class="details-card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
            </div>

            <div class="card" id="returnCard" style="display: none;">
                <h2 style="margin-bottom: 15px;"><i class="fas fa-undo"></i> Ø·Ù„Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ø¥Ù„Ù‰ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹</h2>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <i class="fas fa-comment-alt"></i>
                        <span>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                    </label>
                    <textarea id="notesReturn" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø³Ø¨Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø©..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-warning" onclick="requestReturn()"><i class="fas fa-undo"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</button>
            </div>

            <div class="card" id="updateCard" style="display: none;">
                <h2 style="margin-bottom: 15px;"><i class="fas fa-pen"></i> Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø©</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                        <select id="country">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©</option>
                            <option value="Ø§Ù„Ø£Ø±Ø¯Ù†">Ø§Ù„Ø£Ø±Ø¯Ù†</option>
                            <option value="Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©">Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
                            <option value="Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª">Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
                            <option value="ØªØ±ÙƒÙŠØ§">ØªØ±ÙƒÙŠØ§</option>
                            <option value="Ù…ØµØ±">Ù…ØµØ±</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="amount" type="number" step="0.01"></div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¨Ø¨</label>
                        <select id="reason">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                            <option value="Ù†ÙÙ‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©">Ù†ÙÙ‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©</option>
                            <option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
                            <option value="Ø¹Ù„Ø§Ø¬">Ø¹Ù„Ø§Ø¬</option>
                            <option value="Ø§Ø³ØªØ«Ù…Ø§Ø±">Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØºØ§ÙŠØ©</label>
                        <select id="purpose">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØºØ§ÙŠØ©</option>
                            <option value="Ù…Ø¹ÙŠØ´Ø©">Ù…Ø¹ÙŠØ´Ø©</option>
                            <option value="Ø±Ø³ÙˆÙ…">Ø±Ø³ÙˆÙ…</option>
                            <option value="Ø§Ø¯Ø®Ø§Ø±">Ø§Ø¯Ø®Ø§Ø±</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <i class="fas fa-comment-alt"></i>
                        <span>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                    </label>
                    <textarea id="notesUpdate" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø³Ø¨Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù„Ø©..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-info" onclick="requestUpdate()"><i class="fas fa-pen"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        </main>

        <footer class="footer">
            <p> Ù†Ø¸Ø§Ù… Alawneh-Eway. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©. &copy; 2025</p>
        </footer>
    </div>
</body>
</html>


