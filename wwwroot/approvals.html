<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ù‡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ù‡ - Alawneh-Eway</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        .table th, .table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: right;
            color: #6c757d;
        }
        .table thead th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table tbody tr:nth-of-type(odd) {
            background-color: #fafafa;
        }
        .table tbody tr:hover {
            background-color: #f1f3f5;
        }
        .badge-request-type { 
            padding: 6px 12px; 
            font-weight: bold; 
            color: white; 
            display: inline-block; 
            border-radius: 4px;
            font-size: 0.9em;
        }
        .badge-return { 
            background-color: #dc3545; 
        }
        .badge-update { 
            background-color: #17a2b8; 
        }
    </style>
    <script>
        const API_BASE_URL = 'http://localhost:5216';
        async function loadPending() {
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests?status=1`);
            const list = res.ok ? await res.json() : [];
            const tbody = document.getElementById('pending');
            const countElement = document.getElementById('pendingCount');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯
            if (countElement) {
                countElement.textContent = list.length;
            }
            
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#666;"><i class="fas fa-inbox" style="font-size: 3em;"></i><br><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(c => {
                let requestTypeBadgeClass = '';
                let requestTypeText = '';

                if (c.requestType === 1) {
                    requestTypeText = 'Ø¥Ø±Ø¬Ø§Ø¹';
                    requestTypeBadgeClass = 'badge-return';
                } else if (c.requestType === 2) {
                    requestTypeText = 'ØªØ¹Ø¯ÙŠÙ„';
                    requestTypeBadgeClass = 'badge-update';
                }

                // Ø¹Ø±Ø¶ Ù…ÙØµÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const currentRemittanceDetails = c.remittance ? `
                    <div style="background: white; padding: 12px; margin-top: 8px;">
                        <h4 style="color: #333; margin-bottom: 8px; font-size: 0.95em;">
                            <i class="fas fa-database"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                            <div><strong>Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${c.remittance.sender?.nameAr ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:</strong> ${c.remittance.beneficiary?.nameAr ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ø¯ÙˆÙ„Ø©:</strong> ${c.remittance.country ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <b>${c.remittance.amount?.toFixed(2) ?? '0.00'} Ø¯.Ø£</b></div>
                            <div><strong>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</strong> ${c.remittance.fee?.toFixed(2) ?? '0.00'} Ø¯.Ø£</div>
                            <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ:</strong> <b>${((c.remittance.amount ?? 0) - (c.remittance.fee ?? 0)).toFixed(2)} Ø¯.Ø£</b></div>
                            <div><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${c.remittance.reason ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø§Ù„ØºØ§ÙŠØ©:</strong> ${c.remittance.purpose ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                    </div>
                ` : '<span style="color: #dc3545;">âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';

                // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù…Ø¹ Ù…Ù‚Ø§Ø±Ù†Ø©
                const proposedChanges = c.requestType === 2 ? `
                    <div style="background: white; padding: 12px;">
                        <h4 style="color: #333; margin-bottom: 8px; font-size: 0.95em;">
                            <i class="fas fa-edit"></i> Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
                        </h4>
                        <div style="font-size: 0.85em;">
                            ${c.proposedCountry ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>Ø§Ù„Ø¯ÙˆÙ„Ø©:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.country ?? '-'}</span> 
                                    â†’ 
                                    <span style="font-weight: bold;">${c.proposedCountry}</span>
                                </div>
                            ` : ''}
                            ${c.proposedAmount ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.amount?.toFixed(2) ?? '0.00'} Ø¯.Ø£</span> 
                                    â†’ 
                                    <span style="font-weight: bold;">${c.proposedAmount.toFixed(2)} Ø¯.Ø£</span>
                                </div>
                            ` : ''}
                            ${c.proposedReason ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.reason ?? '-'}</span> 
                                    â†’ 
                                    <span style="font-weight: bold;">${c.proposedReason}</span>
                                </div>
                            ` : ''}
                            ${c.proposedPurpose ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>Ø§Ù„ØºØ§ÙŠØ©:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.purpose ?? '-'}</span> 
                                    â†’ 
                                    <span style="font-weight: bold;">${c.proposedPurpose}</span>
                                </div>
                            ` : ''}
                            ${!c.proposedCountry && !c.proposedAmount && !c.proposedReason && !c.proposedPurpose ? 
                                '<div style="color: #666; text-align: center; padding: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</div>' : ''
                            }
                        </div>
                    </div>
                ` : `
                    <div style="background: white; padding: 12px; text-align: center;">
                        <i class="fas fa-undo" style="font-size: 1.5em; color: #333;"></i>
                        <div style="color: #333; font-weight: bold; margin-top: 8px;">
                            Ø·Ù„Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹"
                        </div>
                    </div>
                `;

                return `
                    <tr>
                        <td style="vertical-align: top;">#${c.id}</td>
                        <td style="min-width: 350px;">
                            <div style="margin-bottom: 8px;">
                                <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ:</strong> <span class="pill">${c.remittance?.reference ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                            </div>
                            ${currentRemittanceDetails}
                        </td>
                        <td style="vertical-align: top;">
                            <span class="badge-request-type ${requestTypeBadgeClass}">${requestTypeText}</span>
                            <div style="margin-top: 8px; font-size: 0.85em;">
                                <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong><br>
                                ${formatDate(c.createdAt)}
                            </div>
                        </td>
                        <td style="vertical-align: top;">
                            ${c.notes ? `
                                <div style="background: white; padding: 8px;">
                                    <i class="fas fa-comment"></i> ${c.notes}
                                </div>
                            ` : '<span style="color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>'}
                        </td>
                        <td style="min-width: 350px;">
                            ${proposedChanges}
                        </td>
                        <td style="vertical-align: top;">
                            <button class="btn btn-success" onclick="approve(${c.id})" style="margin-bottom: 5px; width: 100%;">
                                <i class="fas fa-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯
                            </button>
                            <button class="btn btn-danger" onclick="reject(${c.id})" style="width: 100%;">
                                <i class="fas fa-times"></i> Ø±ÙØ¶
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        async function approve(id) {
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests/${id}/approve`, { method: 'POST' });
            if (!res.ok) { alert('ÙØ´Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø¹Ù„Ù‚ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            const updatedRemittance = await res.json();
            await loadPending();
            alert('âœ… ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø·Ù„Ø¨ Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!\n\nØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.');
            if (updatedRemittance.remittance) {
                printReceipt(updatedRemittance.remittance, 'send');
            }
        }
        
        async function reject(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰ "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹" ÙˆÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.')) {
                return;
            }
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests/${id}/reject`, { method: 'POST' });
            if (!res.ok) { alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø¹Ù„Ù‚ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            const result = await res.json();
            await loadPending();
            alert('âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
                  'ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:\n' +
                  `â€¢ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${id}\n` +
                  `â€¢ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø¥Ù„Ù‰: Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹\n` +
                  `â€¢ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯\n\n` +
                  'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¶: ' + new Date().toLocaleString('ar-SA'));
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // Ø¥Ø¶Ø§ÙØ© 3 Ø³Ø§Ø¹Ø§Øª Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (UTC+3)
            date.setHours(date.getHours() + 3);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const strHours = hours.toString().padStart(2, '0');
            return `${month}/${day}/${year} ${strHours}:${minutes} ${ampm}`;
        }
        
        function printReceipt(remittance, type) {
            const logoSrc = 'images/alawneh.png';
            const receiptDate = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const voucherType = type === 'send' ? 'Ù…Ø³ØªÙ†Ø¯ Ù‚Ø¨Ø¶' : 'Ù…Ø³ØªÙ†Ø¯ ØµØ±Ù';

            const receiptContent = `
                <div style="font-family: 'Arial', sans-serif; direction: rtl; text-align: right; padding: 20px; border: 1px solid #ccc; width: 80mm; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${logoSrc}" alt="Alawneh Logo" style="width: 150px; height: auto; display: block; margin: 0 auto;">
                        <h2 style="color: #007bff; margin-top: 10px;">Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©</h2>
                        <p style="font-size: 14px; color: #555;">${voucherType}</p>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${receiptDate}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ:</strong> ${remittance.reference}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${remittance.sender?.nameAr ?? ''} (${remittance.sender?.nameEn ?? ''})
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:</strong> ${remittance.beneficiary?.nameAr ?? ''} (${remittance.beneficiary?.nameEn ?? ''})
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${remittance.amount?.toFixed(2) ?? '0.00'} Ø¯.Ø£
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${mapStatusToArabic(remittance.status)}
                    </div>
                    <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #777;">
                        Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function mapStatusToArabic(status) {
            switch (status) {
                case 'Payment pending': return 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹';
                case 'Paid': return 'Ù…Ø¯ÙÙˆØ¹Ø©';
                case 'Pending Approval': return 'Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                default: return status;
            }
        }

        document.addEventListener('DOMContentLoaded', loadPending);
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div class="logo">
                    <i class="fas fa-check-circle"></i>
                    <h1>ØµÙØ­Ù‡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ù‡</h1>
                </div>
                <a href="index.html" style="color: #ffffff; text-decoration: none; font-size: 16px; display: flex; align-items: center; gap: 6px; transition: opacity 0.3s;">
                    <i class="fas fa-home"></i>
                    <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </a>
            </div>
            <p class="subtitle">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£Ùˆ Ø±ÙØ¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„</p>
        </header>

        <main class="main-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div>
                        <h3 style="margin: 0; color: #495057;">
                            <i class="fas fa-tasks"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© 
                            <span id="pendingCount" style="background: #007bff; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.9em; margin-right: 10px;">0</span>
                        </h3>
                    </div>
                    <button class="btn btn-primary" onclick="loadPending()">
                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 350px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                                <th style="width: 120px;">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
                                <th style="width: 200px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th style="width: 350px;">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                                <th style="width: 150px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="pending"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p> Ù†Ø¸Ø§Ù… Alawneh-Eway. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©. &copy; 2025</p>
        </footer>
    </div>
    <script src="js/app.js"></script>
</body>
</html>


