<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحه المصادقه - Alawneh-Eway</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        .table th, .table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: right;
            color: #6c757d;
        }
        .table thead th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table tbody tr:nth-of-type(odd) {
            background-color: #fafafa;
        }
        .table tbody tr:hover {
            background-color: #f1f3f5;
        }
        .badge-request-type { 
            padding: 6px 12px; 
            font-weight: bold; 
            color: white; 
            display: inline-block; 
            border-radius: 4px;
            font-size: 0.9em;
        }
        .badge-return { 
            background-color: #dc3545; 
        }
        .badge-update { 
            background-color: #17a2b8; 
        }
    </style>
    <script>
        const API_BASE_URL = 'http://localhost:5216';
        async function loadPending() {
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests?status=1`);
            const list = res.ok ? await res.json() : [];
            const tbody = document.getElementById('pending');
            const countElement = document.getElementById('pendingCount');
            
            // تحديث العدد
            if (countElement) {
                countElement.textContent = list.length;
            }
            
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#666;"><i class="fas fa-inbox" style="font-size: 3em;"></i><br><br>لا توجد طلبات معلقة حالياً</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(c => {
                let requestTypeBadgeClass = '';
                let requestTypeText = '';

                if (c.requestType === 1) {
                    requestTypeText = 'إرجاع';
                    requestTypeBadgeClass = 'badge-return';
                } else if (c.requestType === 2) {
                    requestTypeText = 'تعديل';
                    requestTypeBadgeClass = 'badge-update';
                }

                // عرض مفصل لبيانات الحوالة الحالية
                const currentRemittanceDetails = c.remittance ? `
                    <div style="background: white; padding: 12px; margin-top: 8px;">
                        <h4 style="color: #333; margin-bottom: 8px; font-size: 0.95em;">
                            <i class="fas fa-database"></i> البيانات الحالية
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                            <div><strong>المرسل:</strong> ${c.remittance.sender?.nameAr ?? 'غير محدد'}</div>
                            <div><strong>المستفيد:</strong> ${c.remittance.beneficiary?.nameAr ?? 'غير محدد'}</div>
                            <div><strong>الدولة:</strong> ${c.remittance.country ?? 'غير محدد'}</div>
                            <div><strong>المبلغ:</strong> <b>${c.remittance.amount?.toFixed(2) ?? '0.00'} د.أ</b></div>
                            <div><strong>العمولة:</strong> ${c.remittance.fee?.toFixed(2) ?? '0.00'} د.أ</div>
                            <div><strong>المبلغ الصافي:</strong> <b>${((c.remittance.amount ?? 0) - (c.remittance.fee ?? 0)).toFixed(2)} د.أ</b></div>
                            <div><strong>السبب:</strong> ${c.remittance.reason ?? 'غير محدد'}</div>
                            <div><strong>الغاية:</strong> ${c.remittance.purpose ?? 'غير محدد'}</div>
                        </div>
                    </div>
                ` : '<span style="color: #dc3545;">⚠️ بيانات الحوالة غير متوفرة</span>';

                // عرض التعديلات المقترحة مع مقارنة
                const proposedChanges = c.requestType === 2 ? `
                    <div style="background: white; padding: 12px;">
                        <h4 style="color: #333; margin-bottom: 8px; font-size: 0.95em;">
                            <i class="fas fa-edit"></i> التعديلات المقترحة
                        </h4>
                        <div style="font-size: 0.85em;">
                            ${c.proposedCountry ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>الدولة:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.country ?? '-'}</span> 
                                    → 
                                    <span style="font-weight: bold;">${c.proposedCountry}</span>
                                </div>
                            ` : ''}
                            ${c.proposedAmount ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>المبلغ:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.amount?.toFixed(2) ?? '0.00'} د.أ</span> 
                                    → 
                                    <span style="font-weight: bold;">${c.proposedAmount.toFixed(2)} د.أ</span>
                                </div>
                            ` : ''}
                            ${c.proposedReason ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>السبب:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.reason ?? '-'}</span> 
                                    → 
                                    <span style="font-weight: bold;">${c.proposedReason}</span>
                                </div>
                            ` : ''}
                            ${c.proposedPurpose ? `
                                <div style="background: white; padding: 6px; margin-bottom: 6px;">
                                    <strong>الغاية:</strong> 
                                    <span style="text-decoration: line-through;">${c.remittance?.purpose ?? '-'}</span> 
                                    → 
                                    <span style="font-weight: bold;">${c.proposedPurpose}</span>
                                </div>
                            ` : ''}
                            ${!c.proposedCountry && !c.proposedAmount && !c.proposedReason && !c.proposedPurpose ? 
                                '<div style="color: #666; text-align: center; padding: 10px;">لا توجد تعديلات محددة</div>' : ''
                            }
                        </div>
                    </div>
                ` : `
                    <div style="background: white; padding: 12px; text-align: center;">
                        <i class="fas fa-undo" style="font-size: 1.5em; color: #333;"></i>
                        <div style="color: #333; font-weight: bold; margin-top: 8px;">
                            طلب إرجاع الحوالة إلى حالة "بانتظار الدفع"
                        </div>
                    </div>
                `;

                return `
                    <tr>
                        <td style="vertical-align: top;">#${c.id}</td>
                        <td style="min-width: 350px;">
                            <div style="margin-bottom: 8px;">
                                <strong>الرقم المرجعي:</strong> <span class="pill">${c.remittance?.reference ?? 'غير متوفر'}</span>
                            </div>
                            ${currentRemittanceDetails}
                        </td>
                        <td style="vertical-align: top;">
                            <span class="badge-request-type ${requestTypeBadgeClass}">${requestTypeText}</span>
                            <div style="margin-top: 8px; font-size: 0.85em;">
                                <strong>تاريخ الطلب:</strong><br>
                                ${formatDate(c.createdAt)}
                            </div>
                        </td>
                        <td style="vertical-align: top;">
                            ${c.notes ? `
                                <div style="background: white; padding: 8px;">
                                    <i class="fas fa-comment"></i> ${c.notes}
                                </div>
                            ` : '<span style="color: #999;">لا توجد ملاحظات</span>'}
                        </td>
                        <td style="min-width: 350px;">
                            ${proposedChanges}
                        </td>
                        <td style="vertical-align: top;">
                            <button class="btn btn-success" onclick="approve(${c.id})" style="margin-bottom: 5px; width: 100%;">
                                <i class="fas fa-check"></i> اعتماد
                            </button>
                            <button class="btn btn-danger" onclick="reject(${c.id})" style="width: 100%;">
                                <i class="fas fa-times"></i> رفض
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        async function approve(id) {
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests/${id}/approve`, { method: 'POST' });
            if (!res.ok) { alert('فشل الاعتماد. قد يكون الطلب غير معلق أو غير موجود.'); return; }
            const updatedRemittance = await res.json();
            await loadPending();
            alert('✅ تم اعتماد طلب التغيير بنجاح!\n\nتم تحديث حالة الحوالة وتطبيق التغييرات المطلوبة.');
            if (updatedRemittance.remittance) {
                printReceipt(updatedRemittance.remittance, 'send');
            }
        }
        
        async function reject(id) {
            if (!confirm('هل أنت متأكد من رفض هذا الطلب؟\n\nسيتم إرجاع حالة الحوالة إلى "بانتظار الدفع" ويمكن إعادة إرسال طلب جديد.')) {
                return;
            }
            const res = await fetch(`${API_BASE_URL}/remittances/change-requests/${id}/reject`, { method: 'POST' });
            if (!res.ok) { alert('فشل الرفض. قد يكون الطلب غير معلق أو غير موجود.'); return; }
            const result = await res.json();
            await loadPending();
            alert('❌ تم رفض طلب التغيير بنجاح!\n\n' +
                  '📋 تفاصيل العملية:\n' +
                  `• تم رفض الطلب رقم: ${id}\n` +
                  `• تم إرجاع حالة الحوالة إلى: بانتظار الدفع\n` +
                  `• يمكن الآن إعادة إرسال طلب إرجاع أو تعديل جديد\n\n` +
                  'تاريخ الرفض: ' + new Date().toLocaleString('ar-SA'));
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // إضافة 3 ساعات لتصحيح المنطقة الزمنية (UTC+3)
            date.setHours(date.getHours() + 3);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const strHours = hours.toString().padStart(2, '0');
            return `${month}/${day}/${year} ${strHours}:${minutes} ${ampm}`;
        }
        
        function printReceipt(remittance, type) {
            const logoSrc = 'images/alawneh.png';
            const receiptDate = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const voucherType = type === 'send' ? 'مستند قبض' : 'مستند صرف';

            const receiptContent = `
                <div style="font-family: 'Arial', sans-serif; direction: rtl; text-align: right; padding: 20px; border: 1px solid #ccc; width: 80mm; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${logoSrc}" alt="Alawneh Logo" style="width: 150px; height: auto; display: block; margin: 0 auto;">
                        <h2 style="color: #007bff; margin-top: 10px;">شركة العلاونة للصرافة</h2>
                        <p style="font-size: 14px; color: #555;">${voucherType}</p>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>التاريخ:</strong> ${receiptDate}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>الرقم المرجعي:</strong> ${remittance.reference}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>المرسل:</strong> ${remittance.sender?.nameAr ?? ''} (${remittance.sender?.nameEn ?? ''})
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>المستفيد:</strong> ${remittance.beneficiary?.nameAr ?? ''} (${remittance.beneficiary?.nameEn ?? ''})
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>المبلغ:</strong> ${remittance.amount?.toFixed(2) ?? '0.00'} د.أ
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>الحالة:</strong> ${mapStatusToArabic(remittance.status)}
                    </div>
                    <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #777;">
                        شكراً لاختياركم شركة العلاونة للصرافة
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function mapStatusToArabic(status) {
            switch (status) {
                case 'Payment pending': return 'بانتظار الدفع';
                case 'Paid': return 'مدفوعة';
                case 'Pending Approval': return 'قيد الموافقة';
                default: return status;
            }
        }

        document.addEventListener('DOMContentLoaded', loadPending);
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div class="logo">
                    <i class="fas fa-check-circle"></i>
                    <h1>صفحه المصادقه</h1>
                </div>
                <a href="index.html" style="color: #ffffff; text-decoration: none; font-size: 16px; display: flex; align-items: center; gap: 6px; transition: opacity 0.3s;">
                    <i class="fas fa-home"></i>
                    <span>العودة للصفحة الرئيسية</span>
                </a>
            </div>
            <p class="subtitle">اعتماد أو رفض طلبات الإرجاع والتعديل</p>
        </header>

        <main class="main-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div>
                        <h3 style="margin: 0; color: #495057;">
                            <i class="fas fa-tasks"></i> الطلبات المعلقة 
                            <span id="pendingCount" style="background: #007bff; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.9em; margin-right: 10px;">0</span>
                        </h3>
                    </div>
                    <button class="btn btn-primary" onclick="loadPending()">
                        <i class="fas fa-sync-alt"></i> تحديث القائمة
                    </button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 350px;">بيانات الحوالة الحالية</th>
                                <th style="width: 120px;">نوع الطلب</th>
                                <th style="width: 200px;">ملاحظات</th>
                                <th style="width: 350px;">التعديلات المقترحة</th>
                                <th style="width: 150px;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="pending"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p> نظام Alawneh-Eway. جميع الحقوق محفوظة. &copy; 2025</p>
        </footer>
    </div>
    <script src="js/app.js"></script>
</body>
</html>


