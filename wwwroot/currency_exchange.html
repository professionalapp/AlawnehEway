<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª - Alawneh Eway</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/countries.js"></script>
    <style>
        .exchange-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar a {
            color: #ffffff;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s;
        }

        .highlight {
            color: #007bff;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 15px;
        }

        .group {
            display: flex;
            flex-direction: column;
        }

        .group label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .group input,
        .group select {
            padding: 10px 12px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #ffffff;
        }

        .group input:focus,
        .group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.12);
            outline: none;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f1f5ff;
            color: #007bff;
            border-radius: 20px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 13px;
        }

        .mode-toggle {
            display: inline-flex;
            background: #f8f9fa;
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .mode-toggle button {
            border: none;
            background: transparent;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
        }

        .mode-toggle button.active {
            background: #007bff;
            color: #ffffff;
        }


        .muted {
            color: #6c757d;
            font-size: 13px;
        }

        .hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 6px;
        }
        /* Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© */
        .results { max-height: 200px; overflow: auto; border: 1px solid #ddd; border-radius: 6px; background: #fff; display: none; }
        .results div { padding: 8px 10px; cursor: pointer; color: #6c757d; }
        .results div:hover { background: #f0f0f0; }

        .selected-user { margin-top: 12px; padding: 8px 0; display: none; align-items: center; gap: 10px; }
        .selected-user.show { display: flex; }
        .selected-user i.check-icon { color: #28a745; font-size: 18px; }
        .selected-user .user-info { flex: 1; }
        .selected-user .user-name { color: #495057; font-weight: 600; font-size: 16px; display: block; margin-bottom: 4px; }
        .selected-user .user-id { color: #6c757d; font-size: 13px; display: block; }
        .selected-user .clear-btn { background: transparent; border: 1px solid #dc3545; color: #dc3545; cursor: pointer; font-size: 14px; padding: 6px 12px; border-radius: 6px; transition: all 0.3s; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .selected-user .clear-btn:hover { background: #dc3545; color: white; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); }
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 9999; inset: 0; background: rgba(0,0,0,0.45); }
        .modal-content { background: #ffffff; margin: 60px auto; border-radius: 12px; max-width: 720px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); overflow: hidden; }
        .modal-header { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #fff; padding: 16px 20px; display:flex; align-items:center; justify-content:space-between; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 12px 20px; display:flex; gap:10px; justify-content:flex-end; background:#f8f9fa; }
        .close { cursor: pointer; font-size: 24px; line-height: 1; }
        .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .card-lite { background: #ffffff; border: 1px solid #e9ecef; border-radius: 10px; padding: 12px; }
        .card-lite h4 { margin:0 0 8px 0; font-size: 14px; color:#6c757d; font-weight:600; }
        .big-val { font-size: 18px; font-weight: 800; color:#007bff; }
        .muted-sm { color:#6c757d; font-size:12px; }
    </style>
    <script>
        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ - ÙŠØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
        (function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.replace('login.html');
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="toolbar">
                <div class="logo">
                    <i class="fas fa-money-bill-wave"></i>
                    <h1>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h1>
                </div>
                <div style="display:flex; gap:12px; align-items:center;">
                    
                    <a href="index.html" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                        <i class="fas fa-home"></i>
                        <span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </a>
                </div>
            </div>
            
        </header>

        <main class="main-content">
            <div class="exchange-card">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                    <div class="pill">
                        <i class="fas fa-chart-line"></i>
                        <span>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="rateText">â€”</span> <span id="currencyCode"></span></span>
                    </div>
                    <div class="mode-toggle" role="tablist" aria-label="mode">
                        <button id="sellBtn" class="active" type="button" aria-selected="true">Ø¨ÙŠØ¹ Ø¹Ù…Ù„Ø©</button>
                        <button id="buyBtn" type="button" aria-selected="false">Ø´Ø±Ø§Ø¡ Ø¹Ù…Ù„Ø©</button>
                    </div>
                </div>

                <div class="form-grid" style="margin-bottom:15px;">
                    <div class="group" style="grid-column: 1 / -1;">
                        <label for="userSearch"><i class="fas fa-user"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</label>
                        <input id="userSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø±Ù...">
                        <div id="userSelected" class="selected-user"></div>
                        <div id="userResults" class="results"></div>
                    </div>
                    <div class="group">
                        <label for="countrySelect"><i class="fas fa-globe"></i> Ø§Ù„Ø¹Ù…Ù„Ø©/Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                        <select id="countrySelect"></select>
                        <div class="hint">Ø§Ù„Ø³Ø¹Ø± Ù…Ø­Ø³ÙˆØ¨ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ (JOD)</div>
                    </div>
                    <div class="group">
                        <label for="amountJOD"><i class="fas fa-coins"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ (JOD)</label>
                        <input id="amountJOD" type="number" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="group">
                        <label for="amountFX"><i class="fas fa-money-bill"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© <span class="highlight" id="fxCode">â€”</span></label>
                        <input id="amountFX" type="number" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                    <button id="confirmBtn" class="btn btn-primary" style="padding:10px 16px; border:none; border-radius:8px; cursor:pointer;">
                        <i class="fas fa-check-circle"></i>
                        <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¥ØµØ¯Ø§Ø± ÙˆØµÙ„</span>
                    </button>
                </div>
            </div>

		<!-- Confirmation Modal -->
		<div id="confirmModal" class="modal" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-invoice"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆØµÙ„</h2>
					<span class="close" onclick="closeConfirmModal()">&times;</span>
				</div>
				<div class="modal-body">
					<div class="grid-3" style="margin-bottom:12px;">
						<div class="card-lite">
							<h4>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h4>
							<div class="big-val" id="c_opType">â€”</div>
						</div>
						<div class="card-lite">
							<h4>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</h4>
							<div class="big-val" id="c_employee">â€”</div>
						</div>
						<div class="card-lite">
							<h4>Ø§Ù„Ø¹Ù…Ù„Ø©</h4>
							<div class="big-val" id="c_currency">â€”</div>
						</div>
					</div>
					<div class="grid-2">
						<div class="card-lite">
							<h4>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</h4>
							<div class="big-val" id="c_rate">â€”</div>
						</div>
						<div class="card-lite">
							<h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h4>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
								<div style="background: #f8f9fa; border-radius: 6px; padding: 8px; text-align: center;">
									<div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±</div>
									<div style="font-size: 16px; font-weight: 800; color: #007bff;" id="c_jod">â€”</div>
								</div>
								<div style="background: #f8f9fa; border-radius: 6px; padding: 8px; text-align: center;">
									<div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…Ù„Ø©</div>
									<div style="font-size: 16px; font-weight: 800; color: #28a745;" id="c_fx">â€”</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeConfirmModal()"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
					<button class="btn btn-primary" onclick="issueReceiptAndReset()"><i class="fas fa-print"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆØµÙ„</button>
				</div>
			</div>
		</div>

		</main>

        <footer class="footer">
            <p> Ù†Ø¸Ø§Ù… Alawneh-Eway. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©. &copy; 2025</p>
        </footer>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let rates = [];
        let selected = null; // { country, rate, currency }
        let currentMode = 'sell'; // 'sell' | 'buy'
        let updating = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„
        let chosenUser = null; // { id, name, username }
        let userSearchTimer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
            await testConnection();
            await loadRates();
            bindUI();
        });

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„API
        async function testConnection() {
            try {
                console.log('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„API...');
                const response = await fetch(`${API_BASE_URL}/fx-exchange-rates?t=${Date.now()}`, {
                    method: 'HEAD',
                    cache: 'no-store'
                });
                
                if (response.ok) {
                    console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                } else {
                    console.warn('âš ï¸ API ØºÙŠØ± Ù…ØªØ§Ø­:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„API:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
            }
        }

        async function loadRates() {
            try {
                console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù...');
                const res = await fetch(`${API_BASE_URL}/fx-exchange-rates?t=${Date.now()}`, { 
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©');
                }
                
                rates = await res.json();
                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù:', rates);
                
                if (!Array.isArray(rates)) {
                    throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù„ÙŠØ³Øª Ù…ØµÙÙˆÙØ© ØµØ­ÙŠØ­Ø©');
                }
                
                if (rates.length === 0) {
                    console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù Ù…ØªØ§Ø­Ø©');
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù Ø£ÙˆÙ„Ø§Ù‹.');
                    return;
                }
                
                populateCountries();
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù:', e);
                alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù: ${e.message}`);
            }
        }

        function getCurrencyLabel(currency) {
            const labels = {
                'USD': 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ',
                'EUR': 'ÙŠÙˆØ±Ùˆ',
                'GBP': 'Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ',
                'SAR': 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ',
                'AED': 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ',
                'TRY': 'Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©',
                'EGP': 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ'
            };
            return labels[currency] || currency;
        }

        function populateCountries() {
            const sel = document.getElementById('countrySelect');
            sel.innerHTML = '';
            
            if (!rates || rates.length === 0) {
                console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù Ù…ØªØ§Ø­Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                return;
            }
            
            rates.forEach((r, index) => {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!r.currency || !r.buyRate || !r.sellRate) {
                    console.warn(`Ø³Ø¹Ø± ØµØ±Ù ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index}:`, r);
                    return;
                }
                
                const currency = r.currency;
                const label = getCurrencyLabel(currency);
                
                const opt = document.createElement('option');
                opt.value = currency;
                opt.textContent = `${label} (${currency})`;
                opt.dataset.buyRate = r.buyRate;
                opt.dataset.sellRate = r.sellRate;
                opt.dataset.currency = currency;
                sel.appendChild(opt);
            });
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ø¹Ù†ØµØ±
            if (sel.options.length > 0) {
                sel.selectedIndex = 0;
                onCountryChange();
            } else {
                console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù ØµØ­ÙŠØ­Ø©');
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ø¹Ø§Ø± ØµØ±Ù ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            }
            
            sel.addEventListener('change', onCountryChange);
        }

        function onCountryChange() {
            const sel = document.getElementById('countrySelect');
            const opt = sel.options[sel.selectedIndex];
            
            if (!opt || !opt.value) {
                console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…Ù„Ø© ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            const buyRate = Number(opt.dataset.buyRate || 0);
            const sellRate = Number(opt.dataset.sellRate || 0);
            const currency = opt.dataset.currency || '';
            
            if (buyRate <= 0 || sellRate <= 0) {
                console.error('Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù ØºÙŠØ± ØµØ­ÙŠØ­:', { buyRate, sellRate });
                alert('Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                return;
            }
            
            selected = {
                currency: currency,
                buyRate: buyRate,
                sellRate: sellRate,
                currencyCode: currency
            };
            
            console.log('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©:', selected);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            updateRateDisplay();
            document.getElementById('currencyCode').textContent = selected.currencyCode ? `/${selected.currencyCode}` : '';
            document.getElementById('fxCode').textContent = selected.currencyCode || 'â€”';
            compute();
        }

        function updateRateDisplay() {
            if (!selected) return;
            
            const rateText = document.getElementById('rateText');
            if (currentMode === 'buy') {
                rateText.textContent = selected.buyRate.toFixed(5);
            } else {
                rateText.textContent = selected.sellRate.toFixed(5);
            }
        }

        function bindUI() {
            const sellBtn = document.getElementById('sellBtn');
            const buyBtn = document.getElementById('buyBtn');
            sellBtn.addEventListener('click', () => setMode('sell'));
            buyBtn.addEventListener('click', () => setMode('buy'));

            document.getElementById('amountJOD').addEventListener('input', () => compute('JOD'));
            document.getElementById('amountFX').addEventListener('input', () => compute('FX'));

            const userSearch = document.getElementById('userSearch');
            userSearch.addEventListener('input', onUserSearchInput);
            document.addEventListener('click', (e) => {
                const results = document.getElementById('userResults');
                const searchEl = document.getElementById('userSearch');
                if (!results || !searchEl) return;
                if (!results.contains(e.target) && e.target !== searchEl) {
                    results.style.display = 'none';
                }
            });

            document.getElementById('confirmBtn').addEventListener('click', onConfirm);
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('sellBtn').classList.toggle('active', currentMode === 'sell');
            document.getElementById('buyBtn').classList.toggle('active', currentMode === 'buy');
            updateRateDisplay();
            compute();
        }

        function compute(changed) {
            if (!selected || !selected.buyRate || !selected.sellRate) {
                return;
            }
            if (updating) return;
            updating = true;

            const rate = currentMode === 'buy' ? Number(selected.buyRate) : Number(selected.sellRate);
            const jodEl = document.getElementById('amountJOD');
            const fxEl = document.getElementById('amountFX');
            let jod = Number(jodEl.value || 0);
            let fx = Number(fxEl.value || 0);

            // Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ (Ø³Ø¹Ø± ÙˆØ³ÙŠØ·).
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¯Ø¹Ù… Ø³Ø¹Ø± Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡ Ù…Ù†ÙØµÙ„ÙŠÙ† Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ù…Ø§ ÙÙŠ Ø§Ù„Ù€ API.

            if (changed === 'JOD') {
                // JOD -> FX
                fx = rate > 0 ? (jod / rate) : 0;
                fxEl.value = fx ? fx.toFixed(2) : '';
            } else if (changed === 'FX') {
                // FX -> JOD
                jod = rate > 0 ? (fx * rate) : 0;
                jodEl.value = jod ? jod.toFixed(2) : '';
            } else {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø·/Ø§Ù„Ø¹Ù…Ù„Ø©
                if (jodEl.value) {
                    fx = rate > 0 ? (jod / rate) : 0;
                    fxEl.value = fx ? fx.toFixed(2) : '';
                } else if (fxEl.value) {
                    jod = rate > 0 ? (fx * rate) : 0;
                    jodEl.value = jod ? jod.toFixed(2) : '';
                }
            }

            // ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©

            updating = false;
        }

        // ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© setResult - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù‡Ø§ Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡

        function onUserSearchInput(e) {
            const q = (e.target.value || '').trim().toLowerCase();
            const results = document.getElementById('userResults');
            const selectedBox = document.getElementById('userSelected');
            if (userSearchTimer) clearTimeout(userSearchTimer);
            if (!q || q.length < 2) { results.style.display = 'none'; results.innerHTML = ''; return; }
            userSearchTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/parties/search?q=${encodeURIComponent(q)}`);
                    if (!res.ok) throw new Error('HTTP error');
                    const all = await res.json();
                    const matches = all.slice(0, 5);
                    if (matches.length === 0) { results.innerHTML = '<div>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</div>'; results.style.display = 'block'; return; }
                    results.innerHTML = matches.map(u => `
                        <div data-id="${u.id}" data-name="${escapeHtml(u.nameAr || '')}" data-username="${escapeHtml(u.nameEn || '')}" data-nationalid="${escapeHtml(u.nationalId || '')}">
                            ${escapeHtml(u.nameAr || u.nameEn || ('Party ' + u.id))}<br>
                            <small>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${escapeHtml(u.nationalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</small>
                        </div>
                    `).join('');
                    Array.from(results.children).forEach(row => {
                        row.addEventListener('click', () => {
                            chosenUser = {
                                id: Number(row.getAttribute('data-id')),
                                name: row.getAttribute('data-name') || '',
                                username: row.getAttribute('data-username') || '',
                                nationalId: row.getAttribute('data-nationalid') || ''
                            };
                            selectedBox.innerHTML = `
                                <i class="fas fa-check-circle check-icon"></i>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(chosenUser.name || chosenUser.username)}</span>
                                    <span class="user-id">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${escapeHtml(chosenUser.nationalId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</span>
                                </div>
                                <button class="clear-btn" onclick="clearSelectedUser(event)"><i class=\"fas fa-times\"></i> Ø¥Ù„ØºØ§Ø¡</button>
                            `;
                            selectedBox.classList.add('show');
                            document.getElementById('userSearch').value = '';
                            results.style.display = 'none';
                            results.innerHTML = '';
                        });
                    });
                    results.style.display = 'block';
                } catch (err) {
                    results.innerHTML = '<div>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
                    results.style.display = 'block';
                }
            }, 300);
        }

        function clearSelectedUser(event) {
            event.preventDefault();
            event.stopPropagation();
            chosenUser = null;
            const box = document.getElementById('userSelected');
            box.classList.remove('show');
            box.innerHTML = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function saveCurrencyExchange() {
            const jodVal = Number(document.getElementById('amountJOD').value || 0);
            const fxVal = Number(document.getElementById('amountFX').value || 0);
            const jodAmount = (currentMode === 'sell') ? jodVal : (fxVal * selected.buyRate);
            const fxAmount = (currentMode === 'sell') ? (jodVal/selected.sellRate) : fxVal;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ (ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹)
            const profit = jodAmount * 0.05; // 5% Ø±Ø¨Ø­ ØªÙ‚Ø±ÙŠØ¨ÙŠ
            
            console.log('DEBUG: selected object before API call:', selected);
            console.log('DEBUG: chosenUser object before API call:', chosenUser);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ (Ù…Ø«Ù„ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª)
            const currentUserId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
            console.log('ğŸ” User ID Ù…Ù† localStorage:', localStorage.getItem('userId'));
            console.log('ğŸ” User ID Ù…Ù† sessionStorage:', sessionStorage.getItem('userId'));
            console.log('ğŸ” User ID Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:', currentUserId);

            const exchangeData = {
                type: currentMode === 'sell' ? 2 : 1, // 1=Ø´Ø±Ø§Ø¡, 2=Ø¨ÙŠØ¹
                currency: selected.currencyCode,
                foreignAmount: fxAmount,
                exchangeRate: currentMode === 'buy' ? selected.buyRate : selected.sellRate,
                jodAmount: jodAmount,
                profit: profit,
                customerName: chosenUser?.name || chosenUser?.username || 'Ø¹Ù…ÙŠÙ„',
                customerNationalId: chosenUser?.nationalId || null, // Updated to send nationalId
                customerPhone: null, // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù„Ù„Ù‡Ø§ØªÙ Ù„Ø§Ø­Ù‚Ø§Ù‹
                cashierId: currentUserId ? parseInt(currentUserId) : null, // Ù…Ø¹Ø±Ù ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                notes: `${currentMode === 'sell' ? 'Ø¨ÙŠØ¹' : 'Ø´Ø±Ø§Ø¡'} ${selected.currencyCode}`,
                country: selected.currencyCode
            };

            console.log('Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', exchangeData);

            const response = await fetch(`${API_BASE_URL}/currency-exchanges`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(exchangeData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${errorText}`);
            }

            const result = await response.json();
            console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­:', result);
            console.log('ğŸ” Reference from API:', result?.reference);
            return result;
        }

		function onConfirm() {
            const jodVal = Number(document.getElementById('amountJOD').value || 0);
            const fxVal = Number(document.getElementById('amountFX').value || 0);
            if (!selected || !selected.buyRate || !selected.sellRate) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
            if (!chosenUser) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'); return; }
            if ((currentMode === 'sell' && jodVal <= 0) || (currentMode === 'buy' && fxVal <= 0)) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ­ÙŠØ­'); return; }

			// Populate confirmation modal
			const currencyLabel = getCurrencyLabel(selected.currencyCode);
			document.getElementById('c_opType').textContent = currentMode === 'sell' ? 'Ø¨ÙŠØ¹ Ø¹Ù…Ù„Ø©' : 'Ø´Ø±Ø§Ø¡ Ø¹Ù…Ù„Ø©';
			document.getElementById('c_employee').textContent = (chosenUser?.name || chosenUser?.username || '-');
			document.getElementById('c_currency').textContent = `${selected.currencyCode} (${currencyLabel})`;
			const currentRate = currentMode === 'buy' ? selected.buyRate : selected.sellRate;
			document.getElementById('c_rate').textContent = currentRate.toFixed(5);
			document.getElementById('c_jod').textContent = (currentMode === 'sell' ? jodVal : (fxVal * selected.buyRate)).toFixed(2) + ' JOD';
			document.getElementById('c_fx').textContent = (currentMode === 'sell' ? (jodVal/selected.sellRate) : fxVal).toFixed(2) + ' ' + selected.currencyCode;

			openConfirmModal();
        }

		function openConfirmModal() {
			const m = document.getElementById('confirmModal');
			if (m) m.style.display = 'block';
		}

		function closeConfirmModal() {
			const m = document.getElementById('confirmModal');
			if (m) m.style.display = 'none';
		}

		async function issueReceiptAndReset() {
			closeConfirmModal();
			
			// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ
			let savedExchange;
			try {
				savedExchange = await saveCurrencyExchange();
				console.log('ğŸ” savedExchange object:', savedExchange);
				console.log('ğŸ” savedExchange.reference:', savedExchange?.reference);
			} catch (error) {
				console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', error);
				alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
				return;
			}
			
			const logoSrc = 'images/alawneh.png';
			const now = new Date();
			// Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯
			const ref = savedExchange?.reference || `CE-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${now.getTime().toString().slice(-6)}`;
			console.log('ğŸ” Final reference number:', ref);
			
			// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø£Ùˆ Ù…Ù† localStorage
			const cashierName = savedExchange?.cashier?.name || 
							   localStorage.getItem('name') || 
							   sessionStorage.getItem('name') || 
							   localStorage.getItem('username') || 
							   sessionStorage.getItem('username') || 
							   'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
			console.log('ğŸ” Cashier name:', cashierName);
			
			const opText = currentMode === 'sell' ? 'Ø¨ÙŠØ¹ Ø¹Ù…Ù„Ø©' : 'Ø´Ø±Ø§Ø¡ Ø¹Ù…Ù„Ø©';
			const jodVal = Number(document.getElementById('amountJOD').value || 0);
			const fxVal = Number(document.getElementById('amountFX').value || 0);
			const jodAmount = (currentMode === 'sell') ? jodVal : (fxVal * selected.buyRate);
			const fxAmount = (currentMode === 'sell') ? (jodVal/selected.sellRate) : fxVal;
			const currencyLabel = getCurrencyLabel(selected.currencyCode);
			const currentRate = currentMode === 'buy' ? selected.buyRate : selected.sellRate;
			const arDate = now.toLocaleDateString('ar-JO', { 
				year: 'numeric', 
				month: 'long', 
				day: 'numeric',
				weekday: 'long'
			});
			const enDate = now.toLocaleString('en-US', { 
				year: 'numeric', 
				month: 'long', 
				day: 'numeric', 
				hour: '2-digit', 
				minute: '2-digit',
				second: '2-digit'
			});

			const receiptHtml = `
				<!DOCTYPE html>
				<html dir="rtl" lang="ar">
				<head>
					<meta charset="UTF-8">
					<meta name="viewport" content="width=device-width, initial-scale=1.0">
					<title>ÙˆØµÙ„ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù…Ù„Ø© - ${ref}</title>
					<style>
						@page { 
							size: A4; 
							margin: 10mm; 
						}
						body { 
							font-family: 'Arial', 'Tahoma', sans-serif; 
							direction: rtl; 
							margin: 0; 
							padding: 0; 
							background: white;
						}
						.receipt-container {
							width: 100%;
							max-width: 150mm;
							margin: 0 auto;
							padding: 10px;
							background: white;
							box-shadow: 0 0 10px rgba(0,0,0,0.1);
						}
						.header {
							text-align: center;
							margin-bottom: 20px;
							border-bottom: 3px solid #007bff;
							padding-bottom: 15px;
						}
						.logo {
							width: 120px;
							height: auto;
							margin-bottom: 10px;
						}
						.company-name {
							font-size: 18px;
							font-weight: bold;
							color: #007bff;
							margin: 5px 0;
						}
						.receipt-title {
							font-size: 16px;
							font-weight: bold;
							color: #333;
							margin: 10px 0;
						}
						.reference-info {
							background: #f8f9fa;
							border: 2px solid #007bff;
							border-radius: 8px;
							padding: 15px;
							margin: 15px 0;
							text-align: center;
						}
						.reference-number {
							font-size: 14px;
							font-weight: bold;
							color: #007bff;
							margin-bottom: 5px;
						}
						.date-info {
							font-size: 11px;
							color: #666;
						}
						.details-grid {
							display: grid;
							grid-template-columns: 1fr;
							gap: 8px;
							margin: 15px 0;
						}
						.detail-card {
							background: #ffffff;
							border: 1px solid #e9ecef;
							border-radius: 8px;
							padding: 15px;
							box-shadow: 0 2px 4px rgba(0,0,0,0.1);
						}
						.detail-label {
							font-size: 10px;
							color: #6c757d;
							margin-bottom: 5px;
							font-weight: 600;
						}
						.detail-value {
							font-size: 12px;
							font-weight: bold;
							color: #333;
						}
						.amounts-section {
							background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
							border: 2px solid #007bff;
							border-radius: 12px;
							padding: 20px;
							margin: 20px 0;
						}
						.amounts-title {
							font-size: 14px;
							font-weight: bold;
							color: #007bff;
							text-align: center;
							margin-bottom: 15px;
						}
						.amounts-grid {
							display: grid;
							grid-template-columns: 1fr 1fr;
							gap: 15px;
						}
						.amount-card {
							text-align: center;
							padding: 15px;
							border-radius: 8px;
							box-shadow: 0 2px 8px rgba(0,0,0,0.1);
						}
						.jod-card {
							background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
							border: 2px solid #2196f3;
						}
						.currency-card {
							background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
							border: 2px solid #4caf50;
						}
						.amount-label {
							font-size: 10px;
							font-weight: 600;
							margin-bottom: 8px;
						}
						.jod-label { color: #1976d2; }
						.currency-label { color: #388e3c; }
						.amount-value {
							font-size: 18px;
							font-weight: 800;
							margin-bottom: 5px;
						}
						.jod-value { color: #1976d2; }
						.currency-value { color: #388e3c; }
						.amount-code {
							font-size: 11px;
							font-weight: 600;
						}
						.exchange-rate {
							background: transparent;
							border: none;
							padding: 15px;
							margin: 15px 0;
							text-align: center;
						}
						.rate-label {
							font-size: 11px;
							color: #495057;
							margin-bottom: 5px;
							font-weight: 600;
						}
						.rate-value {
							font-size: 16px;
							font-weight: bold;
							color: #495057;
						}
						.footer {
							text-align: center;
							margin-top: 20px;
							padding-top: 10px;
							border-top: 1px solid #e9ecef;
							color: #6c757d;
							font-size: 10px;
						}
						@media print {
							body { margin: 0; }
							.receipt-container { box-shadow: none; }
						}
					</style>
				</head>
				<body>
					<div class="receipt-container">
						<div class="header">
							<img src="${logoSrc}" alt="Alawneh Logo" class="logo" onerror="this.style.display='none'">
							<div class="company-name">Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©</div>
							<div class="receipt-title">ÙˆØµÙ„ ${opText}</div>
						</div>
						
						<div class="reference-info">
							<div class="reference-number">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${ref}</div>
							<div class="date-info">
								<div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${arDate}</div>
								<div>Date: ${enDate}</div>
							</div>
						</div>
						
						<div class="details-grid">
							<div class="detail-card">
								<div class="detail-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</div>
								<div class="detail-value">${escapeHtml(cashierName)}</div>
							</div>
							<div class="detail-card">
								<div class="detail-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
								<div class="detail-value">${escapeHtml(chosenUser?.name || chosenUser?.username || '-')}</div>
							</div>
							<div class="detail-card">
								<div class="detail-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
								<div class="detail-value">${opText}</div>
							</div>
							<div class="detail-card">
								<div class="detail-label">Ø§Ù„Ø¹Ù…Ù„Ø©</div>
								<div class="detail-value">${selected.currencyCode} (${escapeHtml(currencyLabel)})</div>
							</div>
						</div>
						
						<div class="exchange-rate">
							<div class="rate-label">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
							<div class="rate-value">${currentRate.toFixed(5)}</div>
						</div>
						
						<div class="amounts-section">
							<div class="amounts-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
							<div class="amounts-grid">
								<div class="amount-card jod-card">
									<div class="amount-label jod-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ</div>
									<div class="amount-value jod-value">${jodAmount.toFixed(2)}</div>
									<div class="amount-code">JOD</div>
								</div>
								<div class="amount-card currency-card">
									<div class="amount-label currency-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©</div>
									<div class="amount-value currency-value">${fxAmount.toFixed(2)}</div>
									<div class="amount-code">${selected.currencyCode}</div>
								</div>
							</div>
						</div>
						
						<div class="footer">
							<div>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©</div>
							<div style="margin-top: 5px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</div>
						</div>
					</div>
				</body>
				</html>
			`;

			// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙˆØµÙ„
			const w = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
			w.document.write(receiptHtml);
			w.document.close();
			
			// Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
			w.focus();
			
			// Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
			setTimeout(() => {
				try {
					w.print();
				} catch (error) {
					console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
					// Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙ„ Ø¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
					createAlternativeReceipt(ref, cashierName, opText, jodAmount, fxAmount, selected.currencyCode, currencyLabel, currentRate, arDate, enDate);
				}
			}, 500);

			// Clear fields after issuing receipt
			clearFormAfterReceipt();
		}

		// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙ„ Ø¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
		function createAlternativeReceipt(ref, cashierName, opText, jodAmount, fxAmount, currencyCode, currencyLabel, currentRate, arDate, enDate) {
			const alternativeReceipt = `
				<div style="direction:rtl; font-family: Arial, sans-serif; width: 100%; max-width: 800px; margin: 20px auto; padding: 20px; background: white; border: 2px solid #007bff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
					<div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
						<h2 style="color: #007bff; margin: 5px 0; font-size: 18px;">Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©</h2>
						<h3 style="color: #333; margin: 5px 0; font-size: 16px;">ÙˆØµÙ„ ${opText}</h3>
					</div>
					
					<div style="background: #f8f9fa; border: 1px solid #007bff; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center;">
						<div style="font-size: 14px; font-weight: bold; color: #007bff; margin-bottom: 8px;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${ref}</div>
						<div style="font-size: 11px; color: #666;">
							<div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${arDate}</div>
							<div>Date: ${enDate}</div>
						</div>
					</div>
					
					<div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin: 15px 0;">
						<div style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
							<div style="font-size: 10px; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</div>
							<div style="font-size: 12px; font-weight: bold; color: #333;">${escapeHtml(cashierName)}</div>
						</div>
						<div style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
							<div style="font-size: 10px; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
							<div style="font-size: 12px; font-weight: bold; color: #333;">${escapeHtml(chosenUser?.name || chosenUser?.username || '-')}</div>
						</div>
						<div style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
							<div style="font-size: 10px; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
							<div style="font-size: 12px; font-weight: bold; color: #333;">${opText}</div>
						</div>
						<div style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
							<div style="font-size: 10px; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Ø§Ù„Ø¹Ù…Ù„Ø©</div>
							<div style="font-size: 12px; font-weight: bold; color: #333;">${currencyCode} (${escapeHtml(currencyLabel)})</div>
						</div>
					</div>
					
					<div style="background: transparent; border: none; padding: 10px; margin: 10px 0; text-align: center;">
						<div style="font-size: 11px; color: #495057; margin-bottom: 5px; font-weight: 600;">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
						<div style="font-size: 16px; font-weight: bold; color: #495057;">${currentRate.toFixed(5)}</div>
					</div>
					
					<div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #007bff; border-radius: 12px; padding: 15px; margin: 15px 0;">
						<div style="font-size: 14px; font-weight: bold; color: #007bff; text-align: center; margin-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
							<div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 8px; padding: 10px; text-align: center;">
								<div style="font-size: 10px; color: #1976d2; font-weight: 600; margin-bottom: 8px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ</div>
								<div style="font-size: 18px; font-weight: 800; color: #1976d2; margin-bottom: 5px;">${jodAmount.toFixed(2)}</div>
								<div style="font-size: 11px; font-weight: 600;">JOD</div>
							</div>
							<div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 8px; padding: 10px; text-align: center;">
								<div style="font-size: 10px; color: #388e3c; font-weight: 600; margin-bottom: 8px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©</div>
								<div style="font-size: 18px; font-weight: 800; color: #388e3c; margin-bottom: 5px;">${fxAmount.toFixed(2)}</div>
								<div style="font-size: 11px; font-weight: 600;">${currencyCode}</div>
							</div>
						</div>
					</div>
					
					<div style="text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #e9ecef; color: #6c757d; font-size: 10px;">
						<div>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù„Ø§ÙˆÙ†Ø© Ù„Ù„ØµØ±Ø§ÙØ©</div>
						<div style="margin-top: 5px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</div>
					</div>
				</div>
			`;
			
			// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØµÙ„ Ø§Ù„Ø¨Ø¯ÙŠÙ„
			const altWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
			altWindow.document.write(`
				<!DOCTYPE html>
				<html dir="rtl" lang="ar">
				<head>
					<meta charset="UTF-8">
					<title>ÙˆØµÙ„ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù…Ù„Ø© - ${ref}</title>
					<style>
						body { margin: 0; padding: 20px; background: #f5f5f5; }
						.print-btn { 
							position: fixed; 
							top: 10px; 
							right: 10px; 
							background: #007bff; 
							color: white; 
							border: none; 
							padding: 10px 20px; 
							border-radius: 5px; 
							cursor: pointer; 
							font-size: 14px;
						}
					</style>
				</head>
				<body>
					<button class="print-btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</button>
					${alternativeReceipt}
				</body>
				</html>
			`);
			altWindow.document.close();
			altWindow.focus();
		}

        function clearFormAfterReceipt() {
            const jodEl = document.getElementById('amountJOD');
            const fxEl = document.getElementById('amountFX');
            const userSearchEl = document.getElementById('userSearch');
            const selectedBox = document.getElementById('userSelected');
            const countrySelect = document.getElementById('countrySelect');
            
            // ØªÙØ±ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
            jodEl.value = '';
            fxEl.value = '';
            userSearchEl.value = '';
            chosenUser = null;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
            if (countrySelect && countrySelect.options.length > 0) {
                countrySelect.selectedIndex = 0;
                onCountryChange();
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (selectedBox) { 
                selectedBox.classList.remove('show'); 
                selectedBox.innerHTML = ''; 
            }
            
            // ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø©
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¹
            setMode('sell');
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        setInterval(async () => {
            if (document.visibilityState === 'visible') {
                console.log('Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù...');
                await loadRates();
            }
        }, 300000); // 5 Ø¯Ù‚Ø§Ø¦Ù‚
    </script>
</body>
</html>


